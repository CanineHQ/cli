#!/usr/bin/env bash

set -euo pipefail

echo "üîÑ Fetching latest tags from origin..."
git fetch --tags

echo
echo "üì¶ Existing versions:"
git tag --sort=v:refname | sed 's/^/  - /'

echo
CURRENT_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
echo "üëâ Current version: $CURRENT_VERSION"

echo
read -rp "Enter new version (vX.Y.Z): " NEW_VERSION

# Validate version format
if [[ ! "$NEW_VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
  echo "‚ùå Invalid version format. Use vX.Y.Z (e.g. v0.0.19)"
  exit 1
fi

# Ensure tag does not already exist
if git rev-parse "$NEW_VERSION" >/dev/null 2>&1; then
  echo "‚ùå Tag $NEW_VERSION already exists."
  exit 1
fi

# Ensure clean working tree
if ! git diff-index --quiet HEAD --; then
  echo "‚ùå Working tree is dirty. Commit or stash changes first."
  exit 1
fi

echo
read -rp "üöÄ Release $NEW_VERSION? (y/N): " CONFIRM
if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
  echo "Aborted."
  exit 0
fi

echo "üè∑Ô∏è  Creating tag $NEW_VERSION"
git tag "$NEW_VERSION"

echo "üì§ Pushing tag to origin"
git push origin "$NEW_VERSION"

echo
echo "‚úÖ Successfully released $NEW_VERSION"

# Update Homebrew formula
HOMEBREW_REPO="../homebrew-canine"
FORMULA_PATH="$HOMEBREW_REPO/Formula/canine.rb"

if [[ -d "$HOMEBREW_REPO" ]]; then
  echo
  echo "üç∫ Updating Homebrew formula..."

  TARBALL_URL="https://github.com/CanineHQ/cli/archive/refs/tags/${NEW_VERSION}.tar.gz"
  TEMP_FILE=$(mktemp)

  echo "üì• Downloading tarball to compute sha256..."
  DOWNLOAD_SUCCESS=false
  for i in {1..6}; do
    if curl -sL --fail "$TARBALL_URL" -o "$TEMP_FILE" 2>/dev/null; then
      DOWNLOAD_SUCCESS=true
      break
    fi
    echo "  Attempt $i failed, retrying in 5s..."
    sleep 5
  done

  if $DOWNLOAD_SUCCESS; then
    NEW_SHA256=$(shasum -a 256 "$TEMP_FILE" | awk '{print $1}')
    rm "$TEMP_FILE"

    echo "üîë New sha256: $NEW_SHA256"

    # Update the formula
    cd "$HOMEBREW_REPO"

    # Update version in URL
    sed -i '' "s|archive/refs/tags/v[0-9]*\.[0-9]*\.[0-9]*\.tar\.gz|archive/refs/tags/${NEW_VERSION}.tar.gz|" "$FORMULA_PATH"

    # Update sha256
    sed -i '' "s/sha256 \"[a-f0-9]*\"/sha256 \"${NEW_SHA256}\"/" "$FORMULA_PATH"

    # Commit and push
    git add Formula/canine.rb
    git commit -m "Update canine to ${NEW_VERSION}"
    git push origin main

    echo "‚úÖ Homebrew formula updated to ${NEW_VERSION}"
    cd - > /dev/null
  else
    rm -f "$TEMP_FILE"
    echo "‚ö†Ô∏è  Failed to download tarball after multiple attempts. Update the Homebrew formula manually."
  fi
else
  echo
  echo "‚ö†Ô∏è  Homebrew repo not found at $HOMEBREW_REPO. Skipping formula update."
fi

