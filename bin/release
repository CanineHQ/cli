#!/usr/bin/env bash

set -euo pipefail

echo "ğŸ”„ Fetching latest tags from origin..."
git fetch --tags

echo
echo "ğŸ“¦ Existing versions:"
git tag --sort=v:refname | sed 's/^/  - /'

echo
CURRENT_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
echo "ğŸ‘‰ Current version: $CURRENT_VERSION"

echo
read -rp "Enter new version (vX.Y.Z): " NEW_VERSION

# Validate version format
if [[ ! "$NEW_VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
  echo "âŒ Invalid version format. Use vX.Y.Z (e.g. v0.0.19)"
  exit 1
fi

# Ensure tag does not already exist
if git rev-parse "$NEW_VERSION" >/dev/null 2>&1; then
  echo "âŒ Tag $NEW_VERSION already exists."
  exit 1
fi

# Ensure clean working tree
if ! git diff-index --quiet HEAD --; then
  echo "âŒ Working tree is dirty. Commit or stash changes first."
  exit 1
fi

echo
read -rp "ğŸš€ Release $NEW_VERSION? (y/N): " CONFIRM
if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
  echo "Aborted."
  exit 0
fi

echo "ğŸ·ï¸  Creating tag $NEW_VERSION"
git tag "$NEW_VERSION"

echo "ğŸ“¤ Pushing tag to origin"
git push origin "$NEW_VERSION"

echo
echo "âœ… Successfully released $NEW_VERSION"

